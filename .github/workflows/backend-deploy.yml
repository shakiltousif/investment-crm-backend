# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Deploy Backend

on:
  push:
    branches: ['main']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Check if Yarn is installed
        run: |
          if ! command -v yarn &> /dev/null
          then
            echo "Yarn not found, installing..."
            npm install -g yarn
          else
            echo "Yarn is already installed."
          fi

      - name: Install dependencies
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: yarn install

      - name: write environment variables to .env
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          touch .env
          echo "${{ secrets.BACKEND_ENV_FILE }}" >> .env

      - name: Check and start Docker Compose services (PostgreSQL and Redis)
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          # Check if postgres container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_db$'; then
            echo "PostgreSQL container is not running. Starting Docker Compose services..."
            docker-compose up -d postgres redis
            echo "Waiting for services to be healthy..."
            sleep 10
          else
            echo "PostgreSQL container is already running."
          fi
          
          # Check if redis container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_redis$'; then
            echo "Redis container is not running. Starting Redis..."
            docker-compose up -d redis
            echo "Waiting for Redis to be healthy..."
            sleep 5
          else
            echo "Redis container is already running."
          fi

      - name: Setup PM2 directory and permissions
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          # Get the current user and home directory
          CURRENT_USER=$(whoami)
          PM2_USER_HOME="${HOME:-/home/$CURRENT_USER}"
          PM2_HOME_DIR="${PM2_USER_HOME}/.pm2"
          
          echo "Current user: $CURRENT_USER"
          echo "PM2 directory: $PM2_HOME_DIR"
          
          # Aggressively kill all PM2 processes and daemons
          export PATH="/opt/nodejs/bin:$PATH"
          export PM2_HOME="$PM2_HOME_DIR"
          
          echo "Killing all PM2 processes..."
          # Try to kill PM2 daemon gracefully first
          /opt/nodejs/bin/pm2 kill 2>/dev/null || true
          
          # Kill any PM2 processes by name (more aggressive)
          pkill -f "pm2" 2>/dev/null || true
          pkill -f "node.*pm2" 2>/dev/null || true
          
          # Wait a moment for processes to terminate
          sleep 2
          
          # Remove stale socket files - use sudo if available to ensure removal
          if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
            echo "Removing stale PM2 socket files..."
            if command -v sudo &> /dev/null; then
              sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
            else
              rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
            fi
          fi
          
          # Create PM2 directory with proper permissions if it doesn't exist
          if [ ! -d "$PM2_HOME_DIR" ]; then
            echo "Creating PM2 directory at $PM2_HOME_DIR"
            mkdir -p "$PM2_HOME_DIR"
          else
            echo "PM2 directory already exists at $PM2_HOME_DIR"
          fi
          
          # Fix ownership of PM2 directory and all its contents
          # This ensures socket files will be created with correct ownership
          if command -v sudo &> /dev/null; then
            echo "Fixing ownership with sudo..."
            sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || {
              echo "Warning: Sudo chown failed, but continuing..."
            }
          else
            echo "Sudo not available, trying chown without sudo..."
            chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || {
              echo "Warning: Could not change ownership. This may cause issues if files were created by another user."
            }
          fi
          
          # Ensure proper permissions on PM2 directory and contents
          chmod -R 755 "$PM2_HOME_DIR" 2>/dev/null || true
          
          # Verify the directory is writable by current user
          if [ ! -w "$PM2_HOME_DIR" ]; then
            echo "Error: PM2 directory $PM2_HOME_DIR is not writable by current user $CURRENT_USER"
            ls -la "$PM2_HOME_DIR" || true
            exit 1
          fi
          
          echo "PM2 directory permissions verified successfully"
          
          # Export PM2_HOME for subsequent steps
          echo "PM2_HOME=$PM2_HOME_DIR" >> $GITHUB_ENV
          echo "PM2 directory set to: $PM2_HOME_DIR"

      - name: Check and start PM2 process
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        env:
          PM2_HOME: ${{ env.PM2_HOME }}
        run: |
          # Use the PM2_HOME from environment or fallback to user home
          CURRENT_USER=$(whoami)
          PM2_HOME_DIR="${PM2_HOME:-${HOME:-/home/$CURRENT_USER}/.pm2}"
          export PM2_HOME="$PM2_HOME_DIR"
          export PATH="/opt/nodejs/bin:$PATH"
          
          # PM2 command
          PM2_CMD="/opt/nodejs/bin/pm2"
          
          # Aggressively kill all PM2 processes and daemons
          echo "Ensuring PM2 daemon is completely stopped..."
          
          # First, remove socket files to prevent PM2 from connecting to existing daemon
          if command -v sudo &> /dev/null; then
            echo "Removing socket files to disconnect from existing daemon..."
            sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
          fi
          
          # Try to kill PM2 daemon for current user's PM2_HOME
          $PM2_CMD kill 2>/dev/null || true
          
          # Kill all PM2 processes system-wide (including root)
          pkill -9 -f "pm2" 2>/dev/null || true
          pkill -9 -f "node.*pm2" 2>/dev/null || true
          
          # Also try to kill PM2 daemons that might be running for other users (especially root)
          if command -v sudo &> /dev/null; then
            echo "Killing root PM2 daemon..."
            # Kill PM2 processes for all users (in case root or another user has a daemon running)
            sudo pkill -9 -f "pm2" 2>/dev/null || true
            sudo pkill -9 -f "node.*pm2" 2>/dev/null || true
            
            # Try to kill PM2 daemon using root's PM2_HOME
            # Root's PM2 might be using /root/.pm2 or the user's .pm2 directory
            sudo PM2_HOME=/root/.pm2 /opt/nodejs/bin/pm2 kill 2>/dev/null || true
            sudo PM2_HOME="$PM2_HOME_DIR" /opt/nodejs/bin/pm2 kill 2>/dev/null || true
            
            # Find and kill any PM2 daemon processes by PID if pm2.pid exists
            if [ -f "$PM2_HOME_DIR/pm2.pid" ]; then
              PM2_PID=$(sudo cat "$PM2_HOME_DIR/pm2.pid" 2>/dev/null || echo "")
              if [ -n "$PM2_PID" ] && [ "$PM2_PID" != "0" ]; then
                echo "Killing PM2 daemon with PID: $PM2_PID"
                sudo kill -9 "$PM2_PID" 2>/dev/null || true
              fi
            fi
          fi
          
          # Wait for processes to fully terminate
          sleep 3
          
          # Remove ALL socket files and PM2 runtime files that might have wrong ownership
          echo "Cleaning up PM2 runtime files..."
          if command -v sudo &> /dev/null; then
            # Remove socket files with sudo (must be done after daemon is killed)
            sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
            # Remove PID files
            sudo rm -f "$PM2_HOME_DIR/pm2.pid" "$PM2_HOME_DIR"/*.pid 2>/dev/null || true
            # Remove lock files
            sudo rm -f "$PM2_HOME_DIR/.pm2.lock" 2>/dev/null || true
            # Fix ownership of entire directory
            sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || true
          else
            rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
            rm -f "$PM2_HOME_DIR/pm2.pid" "$PM2_HOME_DIR"/*.pid 2>/dev/null || true
            rm -f "$PM2_HOME_DIR/.pm2.lock" 2>/dev/null || true
          fi
          
          # Verify socket files are gone and stay gone
          for i in 1 2 3; do
            if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
              echo "Warning: Socket files still exist (attempt $i), removing again..."
              if command -v sudo &> /dev/null; then
                sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
                # Kill any process that might be recreating them
                sudo pkill -9 -f "pm2" 2>/dev/null || true
              fi
              sleep 1
            else
              break
            fi
          done
          
          # Ensure directory ownership is correct one more time
          if command -v sudo &> /dev/null; then
            sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || true
            # Also ensure the directory itself has correct permissions
            sudo chmod 755 "$PM2_HOME_DIR" 2>/dev/null || true
          fi
          
          # Final check: Verify no PM2 processes are running
          if pgrep -f "pm2" > /dev/null; then
            echo "Warning: PM2 processes still running, attempting final kill..."
            pkill -9 -f "pm2" 2>/dev/null || true
            if command -v sudo &> /dev/null; then
              sudo pkill -9 -f "pm2" 2>/dev/null || true
            fi
            sleep 2
          fi
          
          # Verify socket files are definitely gone before proceeding
          if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
            echo "ERROR: Socket files still exist after cleanup. This indicates a PM2 daemon is still running."
            echo "Socket file details:"
            ls -la "$PM2_HOME_DIR"/*.sock 2>/dev/null || true
            echo "PM2 processes:"
            ps aux | grep -i pm2 | grep -v grep || true
            exit 1
          fi
          
          echo "PM2 cleanup completed successfully. Socket files removed and daemon stopped."
          
          # Verify PM2 directory exists and is writable
          if [ ! -w "$PM2_HOME_DIR" ]; then
            echo "Error: PM2 directory $PM2_HOME_DIR is not writable"
            ls -la "$(dirname $PM2_HOME_DIR)"
            exit 1
          fi
          
          # Build the application first if dist doesn't exist
          if [ ! -d "dist" ]; then
            echo "Building application..."
            yarn build
          fi
          
          # Try to check if PM2 process exists, but don't fail if we can't connect
          # (This might fail if daemon is not running or has permission issues)
          PM2_PROCESS_EXISTS=false
          if $PM2_CMD list 2>/dev/null | grep -q "investment-crm-backend"; then
            PM2_PROCESS_EXISTS=true
            echo "PM2 process 'investment-crm-backend' found in list."
          else
            echo "PM2 process 'investment-crm-backend' not found (or PM2 daemon not accessible)."
          fi
          
          # If process exists, try to restart it
          if [ "$PM2_PROCESS_EXISTS" = true ]; then
            echo "Attempting to restart existing process..."
            if $PM2_CMD restart investment-crm-backend 2>/dev/null; then
              echo "Process restarted successfully."
            else
              echo "Restart failed, will delete and start fresh..."
              $PM2_CMD delete investment-crm-backend 2>/dev/null || true
              PM2_PROCESS_EXISTS=false
            fi
          fi
          
          # If process doesn't exist or restart failed, start it fresh
          if [ "$PM2_PROCESS_EXISTS" = false ]; then
            echo "Starting PM2 process 'investment-crm-backend'..."
            
            # Final check: Ensure socket files don't exist before starting
            if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
              echo "WARNING: Socket files exist before PM2 start. Removing them..."
              if command -v sudo &> /dev/null; then
                sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
                sudo pkill -9 -f "pm2" 2>/dev/null || true
                sleep 1
              fi
            fi
            
            # Start with PM2 - this will create a new daemon if one doesn't exist
            # The daemon will be created as the current user since we've cleaned up everything
            PM2_START_SUCCESS=false
            for retry in 1 2 3; do
              echo "Attempting to start PM2 (attempt $retry)..."
              
              # Remove socket files right before starting (in case they were recreated)
              if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
                echo "Removing socket files before start attempt..."
                if command -v sudo &> /dev/null; then
                  sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
                fi
              fi
              
              # Try to start PM2
              if $PM2_CMD start dist/index.js --name investment-crm-backend 2>&1; then
                PM2_START_SUCCESS=true
                echo "PM2 started successfully!"
                break
              else
                echo "PM2 start failed on attempt $retry"
                if [ $retry -lt 3 ]; then
                  echo "Cleaning up and retrying..."
                  # Kill any PM2 processes that might have started
                  pkill -9 -f "pm2" 2>/dev/null || true
                  if command -v sudo &> /dev/null; then
                    sudo pkill -9 -f "pm2" 2>/dev/null || true
                    sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
                    sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || true
                  fi
                  sleep 2
                fi
              fi
            done
            
            if [ "$PM2_START_SUCCESS" = false ]; then
              echo "ERROR: PM2 start failed after 3 attempts."
              echo "PM2 directory contents:"
              ls -la "$PM2_HOME_DIR" || true
              echo "PM2 processes:"
              ps aux | grep -i pm2 | grep -v grep || true
              exit 1
            fi
            
            $PM2_CMD save 2>/dev/null || true
          fi
          
          # Verify the process is actually running
          sleep 3
          if $PM2_CMD list 2>&1 | grep -q "investment-crm-backend.*online"; then
            echo "✅ PM2 process is running successfully"
            $PM2_CMD describe investment-crm-backend
          else
            echo "⚠️  PM2 process may not be running correctly"
            $PM2_CMD list
            $PM2_CMD logs investment-crm-backend --lines 20 --nostream
          fi

      - name: Log PM2
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        env:
          PM2_HOME: ${{ env.PM2_HOME }}
        run: |
          PM2_HOME_DIR="${PM2_HOME:-${HOME:-/home/$(whoami)}/.pm2}"
          export PM2_HOME="$PM2_HOME_DIR"
          export PATH="/opt/nodejs/bin:$PATH"
          /opt/nodejs/bin/pm2 logs --nostream --lines 50

