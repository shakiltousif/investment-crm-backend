# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Deploy Backend

on:
  push:
    branches: ['main']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Fix workspace permissions (pre-checkout)
        env:
          RUNNER_ALLOW_RUNASROOT: 1
        run: |
          echo "Fixing permissions on workspace directory before checkout..."
          # Try to find the workspace directory in common locations
          # Based on the error path structure
          BASE_DIR="/home/signin-fil-investments-api/htdocs/api.signin-fil-investments.com/actions-runner/_work"
          REPO_NAME="investment-crm-backend"
          
          # Try the expected workspace path
          WORKSPACE_PATH="$BASE_DIR/$REPO_NAME/$REPO_NAME"
          
          # Also try alternative patterns
          for path in "$WORKSPACE_PATH" "$BASE_DIR/$REPO_NAME" "$PWD"; do
            if [ -d "$path" ]; then
              echo "Found workspace at: $path"
              echo "Fixing permissions recursively..."
              # Fix permissions recursively, ignoring errors
              chmod -R u+w "$path" 2>/dev/null || true
              # Specifically ensure .github directory is writable
              if [ -d "$path/.github" ]; then
                echo "Fixing .github directory permissions..."
                chmod -R u+w "$path/.github" 2>/dev/null || true
                if [ -d "$path/.github/workflows" ]; then
                  chmod -R u+w "$path/.github/workflows" 2>/dev/null || true
                fi
              fi
              echo "Permissions fixed on: $path"
              break
            fi
          done
          
          # Also try to fix parent directories that might have permission issues
          if [ -d "$BASE_DIR/$REPO_NAME" ]; then
            chmod -R u+w "$BASE_DIR/$REPO_NAME" 2>/dev/null || true
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: true
          persist-credentials: false

      - name: Clean repository workspace
        env:
          RUNNER_ALLOW_RUNASROOT: 1
        run: |
          echo "Cleaning repository workspace..."
          # Fix permissions on logs directory if it exists
          # Logs directory is in .gitignore, so we just need to clean it up
          if [ -d "logs" ]; then
            echo "Cleaning logs directory..."
            # Try multiple methods to clean logs directory
            rm -rf logs/* 2>/dev/null || true
            find logs -type f -delete 2>/dev/null || true
            # If still can't delete, try to change permissions first
            chmod -R u+w logs 2>/dev/null || true
            rm -rf logs/* 2>/dev/null || true
            echo "Logs directory cleanup attempted (may have permission issues, but continuing...)"
          fi
          # Clean git state (skip if it fails due to permissions)
          git clean -fdx -e logs/ 2>/dev/null || echo "Warning: git clean failed, continuing..."
          git reset --hard HEAD 2>/dev/null || echo "Warning: git reset failed, continuing..."

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Check if Yarn is installed
        run: |
          if ! command -v yarn &> /dev/null
          then
            echo "Yarn not found, installing..."
            npm install -g yarn
          else
            echo "Yarn is already installed."
          fi

      - name: Install dependencies
        run: yarn install

      - name: write environment variables to .env
        run: |
          touch .env
          echo "${{ secrets.BACKEND_ENV_FILE }}" >> .env

      - name: Check and start Docker Compose services (PostgreSQL and Redis)
        run: |
          # Check if postgres container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_db$'; then
            echo "PostgreSQL container is not running. Starting Docker Compose services..."
            docker-compose up -d postgres redis
            echo "Waiting for services to be healthy..."
            sleep 10
          else
            echo "PostgreSQL container is already running."
          fi
          
          # Check if redis container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_redis$'; then
            echo "Redis container is not running. Starting Redis..."
            docker-compose up -d redis
            echo "Waiting for Redis to be healthy..."
            sleep 5
          else
            echo "Redis container is already running."
          fi

      # - name: Restart PM2 process
      #   run: |
      #     # Use runner user's HOME to avoid /root permission issues
      #     export HOME=/root

      #     # Build the application first if dist doesn't exist
      #     if [ ! -d "dist" ]; then
      #       echo "Building application..."
      #       yarn build
      #     fi
          
      #     # Ensure PM2 is on PATH and select executable
      #     PM2_BIN="/opt/nodejs/bin/pm2"

      #     if ! command -v "$PM2_BIN" >/dev/null 2>&1; then
      #       PM2_BIN="$(command -v pm2 || true)"
      #     fi
      #     echo "Using PM2 at: ${PM2_BIN:-pm2-not-found}"
          
      #     RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" restart investment-crm-backend
          
      #     # Wait up to 10s for process to become online
      #     for i in $(seq 1 10); do
      #       if RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" list 2>&1 | grep -q "investment-crm-backend.*online"; then
      #         break
      #       fi
      #       sleep 1
      #     done
          
      #     # Verify the process is actually running
      #     if RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" list 2>&1 | grep -q "investment-crm-backend.*online"; then
      #       echo "✅ PM2 process is running successfully"
      #       RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" describe investment-crm-backend
      #     else
      #       echo "⚠️  PM2 process may not be running correctly"
      #       RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" list
      #       RUNNER_ALLOW_RUNASROOT=1 "$PM2_BIN" logs investment-crm-backend --lines 20 --nostream
      #     fi

      # - name: Check PM2 logs
      #   run: |
      #     export PATH="/opt/nodejs/bin:$PATH"
      #     export PM2_HOME="/tmp/pm2-$(whoami)"
      #     /opt/nodejs/bin/pm2 logs investment-crm-backend --nostream --lines 50