# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Deploy Backend

on:
  push:
    branches: ['main']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Pre-checkout cleanup (handle permission issues)
        env:
          RUNNER_ALLOW_RUNASROOT: 1
        run: |
          echo "Pre-checkout cleanup to handle permission issues..."
          # Based on the error, the workspace is typically in _work directory
          # Try to find and clean logs directories in common locations
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          
          # Common workspace patterns for self-hosted runners
          # Based on error path: /home/signin-fil-investments-api/htdocs/api.signin-fil-investments.com/actions-runner/_work
          for base_dir in "/home/signin-fil-investments-api/htdocs/api.signin-fil-investments.com/actions-runner/_work" "$HOME/actions-runner/_work" "/opt/actions-runner/_work" "$PWD"; do
            if [ -d "$base_dir" ]; then
              # Look for the repository directory (try both repo name variations)
              for repo_dir in "$base_dir/$REPO_NAME" "$base_dir/investment-crm-backend" "$base_dir"/*/"$REPO_NAME" "$base_dir"/*/investment-crm-backend; do
                if [ -d "$repo_dir/logs" ]; then
                  echo "Found logs directory at $repo_dir/logs, cleaning..."
                  chmod -R u+w "$repo_dir/logs" 2>/dev/null || true
                  rm -rf "$repo_dir/logs"/* 2>/dev/null || true
                  find "$repo_dir/logs" -type f -delete 2>/dev/null || true
                fi
              done
            fi
          done
          echo "Pre-checkout cleanup completed"

      - uses: actions/checkout@v4
        env:
          RUNNER_ALLOW_RUNASROOT: 1
        continue-on-error: true
        with:
          clean: false
          fetch-depth: 0
          lfs: false

      - name: Clean repository workspace
        env:
          RUNNER_ALLOW_RUNASROOT: 1
        run: |
          echo "Cleaning repository workspace..."
          # Fix permissions on logs directory if it exists
          # Logs directory is in .gitignore, so we just need to clean it up
          if [ -d "logs" ]; then
            echo "Cleaning logs directory..."
            # Try multiple methods to clean logs directory
            rm -rf logs/* 2>/dev/null || true
            find logs -type f -delete 2>/dev/null || true
            # If still can't delete, try to change permissions first
            chmod -R u+w logs 2>/dev/null || true
            rm -rf logs/* 2>/dev/null || true
            echo "Logs directory cleanup attempted (may have permission issues, but continuing...)"
          fi
          # Clean git state (skip if it fails due to permissions)
          git clean -fdx -e logs/ 2>/dev/null || echo "Warning: git clean failed, continuing..."
          git reset --hard HEAD 2>/dev/null || echo "Warning: git reset failed, continuing..."

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Check if Yarn is installed
        run: |
          if ! command -v yarn &> /dev/null
          then
            echo "Yarn not found, installing..."
            npm install -g yarn
          else
            echo "Yarn is already installed."
          fi

      - name: Install dependencies
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: yarn install

      - name: write environment variables to .env
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          touch .env
          echo "${{ secrets.BACKEND_ENV_FILE }}" >> .env

      - name: Check and start Docker Compose services (PostgreSQL and Redis)
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          # Check if postgres container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_db$'; then
            echo "PostgreSQL container is not running. Starting Docker Compose services..."
            docker-compose up -d postgres redis
            echo "Waiting for services to be healthy..."
            sleep 10
          else
            echo "PostgreSQL container is already running."
          fi
          
          # Check if redis container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_redis$'; then
            echo "Redis container is not running. Starting Redis..."
            docker-compose up -d redis
            echo "Waiting for Redis to be healthy..."
            sleep 5
          else
            echo "Redis container is already running."
          fi

      - name: Restart PM2 process
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          # Get current user and set HOME to their home directory (not root)
          CURRENT_USER=$(whoami)
          USER_HOME="${HOME:-/home/$CURRENT_USER}"
          export HOME="$USER_HOME"
          
          # Ensure user's .config directory exists and is writable
          mkdir -p "$USER_HOME/.config/yarn" 2>/dev/null || true
          chmod -R u+w "$USER_HOME/.config" 2>/dev/null || true
          
          # Redirect Yarn config to writable location to avoid permission errors
          # Use project directory for yarn config to avoid any permission issues
          YARN_CONFIG_DIR="${{ secrets.BACKEND_DEPLOY_PATH }}/.yarn-config"
          mkdir -p "$YARN_CONFIG_DIR/yarn"
          export XDG_CONFIG_HOME="$YARN_CONFIG_DIR"
          export YARN_CACHE_FOLDER="$YARN_CONFIG_DIR/cache"
          
          echo "Current user: $CURRENT_USER"
          echo "HOME: $HOME"
          echo "XDG_CONFIG_HOME: $XDG_CONFIG_HOME"
          echo "User config directory: $USER_HOME/.config"
          
          # Build the application first if dist doesn't exist
          if [ ! -d "dist" ]; then
            echo "Building application..."
            yarn build
          fi
          
          # Set PM2_HOME explicitly
          PM2_HOME_DIR="$USER_HOME/.pm2"
          export PM2_HOME="$PM2_HOME_DIR"
          export PATH="/opt/nodejs/bin:$PATH"
          
          echo "PM2_HOME: $PM2_HOME"
          
          # Fix PM2 socket permissions before attempting to use PM2
          echo "Fixing PM2 socket permissions..."
          
          # Find and kill all PM2 daemon processes by PID
          echo "Finding all PM2 daemon processes..."
          PM2_PIDS=$(ps aux | grep -i "PM2.*God Daemon" | grep -v grep | awk '{print $2}' | tr '\n' ' ')
          if [ -n "$PM2_PIDS" ]; then
            echo "Found PM2 daemon PIDs: $PM2_PIDS"
            for pid in $PM2_PIDS; do
              echo "Killing PM2 daemon PID: $pid"
              sudo kill -9 "$pid" 2>/dev/null || true
            done
          fi
          
          # Kill all PM2-related processes more aggressively
          echo "Killing all PM2 processes..."
          sudo pkill -9 -f "pm2" 2>/dev/null || true
          sudo pkill -9 -f "PM2" 2>/dev/null || true
          
          # Try PM2 kill commands with different PM2_HOME values
          sudo PM2_HOME=/root/.pm2 /opt/nodejs/bin/pm2 kill 2>/dev/null || true
          sudo PM2_HOME="$PM2_HOME_DIR" /opt/nodejs/bin/pm2 kill 2>/dev/null || true
          /opt/nodejs/bin/pm2 kill 2>/dev/null || true
          
          # Wait for processes to die
          sleep 3
          
          # Remove socket files immediately after killing daemons
          echo "Removing socket files..."
          if command -v sudo &> /dev/null; then
            sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
            sudo rm -f "$PM2_HOME_DIR/pm2.pid" 2>/dev/null || true
            # Also remove from root's PM2 directory
            sudo rm -f /root/.pm2/rpc.sock /root/.pm2/pub.sock 2>/dev/null || true
          fi
          
          # Loop to ensure socket files stay removed and daemons stay dead
          for attempt in 1 2 3; do
            # Check if any PM2 daemons are still running
            REMAINING_PIDS=$(ps aux | grep -i "PM2.*God Daemon" | grep -v grep | awk '{print $2}' | tr '\n' ' ')
            if [ -n "$REMAINING_PIDS" ]; then
              echo "Attempt $attempt: Found remaining PM2 daemons, killing them..."
              for pid in $REMAINING_PIDS; do
                sudo kill -9 "$pid" 2>/dev/null || true
              done
              sleep 2
            fi
            
            # Remove socket files again if they were recreated
            if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
              echo "Attempt $attempt: Socket files recreated, removing again..."
              sudo rm -f "$PM2_HOME_DIR/rpc.sock" "$PM2_HOME_DIR/pub.sock" 2>/dev/null || true
              sudo pkill -9 -f "pm2" 2>/dev/null || true
              sleep 1
            else
              echo "Socket files successfully removed on attempt $attempt"
              break
            fi
          done
          
          # Final verification - socket files must be gone
          if [ -f "$PM2_HOME_DIR/rpc.sock" ] || [ -f "$PM2_HOME_DIR/pub.sock" ]; then
            echo "ERROR: Socket files still exist after all cleanup attempts"
            echo "This indicates a PM2 daemon is still running and recreating them"
            echo "Socket files:"
            ls -la "$PM2_HOME_DIR"/*.sock 2>/dev/null || true
            echo "PM2 processes:"
            ps aux | grep -i pm2 | grep -v grep || true
            exit 1
          fi
          
          # Ensure .pm2 directory exists and has correct ownership
          mkdir -p "$PM2_HOME_DIR" 2>/dev/null || true
          if command -v sudo &> /dev/null; then
            sudo chown -R "$CURRENT_USER:$CURRENT_USER" "$PM2_HOME_DIR" 2>/dev/null || true
            sudo chmod -R 755 "$PM2_HOME_DIR" 2>/dev/null || true
          fi
          
          echo "PM2 cleanup completed. Socket files removed and all daemons killed."
          
          # Restart PM2 process
          /opt/nodejs/bin/pm2 restart investment-crm-backend 2>&1 || {
            echo "PM2 restart failed, trying to start instead..."
            /opt/nodejs/bin/pm2 start dist/index.js --name investment-crm-backend 2>&1 || {
              echo "PM2 start also failed"
              echo "Checking PM2 directory state:"
              ls -la "$PM2_HOME_DIR" 2>/dev/null || true
              echo "Checking for PM2 processes:"
              ps aux | grep -i pm2 | grep -v grep || true
              exit 1
            }
          }
          
          # Verify the process is actually running
          sleep 3
          if /opt/nodejs/bin/pm2 list 2>&1 | grep -q "investment-crm-backend.*online"; then
            echo "✅ PM2 process is running successfully"
            /opt/nodejs/bin/pm2 describe investment-crm-backend
          else
            echo "⚠️  PM2 process may not be running correctly"
            /opt/nodejs/bin/pm2 list
            /opt/nodejs/bin/pm2 logs investment-crm-backend --lines 20 --nostream
          fi

      - name: Check PM2 logs
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          export PATH="/opt/nodejs/bin:$PATH"
          /opt/nodejs/bin/pm2 logs investment-crm-backend --nostream --lines 50