# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Deploy Backend

on:
  push:
    branches: ['main']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Check if Yarn is installed
        run: |
          if ! command -v yarn &> /dev/null
          then
            echo "Yarn not found, installing..."
            npm install -g yarn
          else
            echo "Yarn is already installed."
          fi

      - name: Install dependencies
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: yarn install

      - name: write environment variables to .env
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          touch .env
          echo "${{ secrets.BACKEND_ENV_FILE }}" >> .env

      - name: Check and start Docker Compose services (PostgreSQL and Redis)
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          # Check if postgres container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_db$'; then
            echo "PostgreSQL container is not running. Starting Docker Compose services..."
            docker-compose up -d postgres redis
            echo "Waiting for services to be healthy..."
            sleep 10
          else
            echo "PostgreSQL container is already running."
          fi
          
          # Check if redis container is running
          if ! docker ps --format '{{.Names}}' | grep -q '^investment_crm_redis$'; then
            echo "Redis container is not running. Starting Redis..."
            docker-compose up -d redis
            echo "Waiting for Redis to be healthy..."
            sleep 5
          else
            echo "Redis container is already running."
          fi

      - name: Check and start PM2 process
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: |
          export HOME=/root
          
          # Check if PM2 process exists and is running
          if RUNNER_ALLOW_RUNASROOT=1 /opt/nodejs/bin/pm2 list | grep -q 'investment-crm-backend.*online'; then
            echo "PM2 process 'investment-crm-backend' is already running. Restarting..."
            RUNNER_ALLOW_RUNASROOT=1 /opt/nodejs/bin/pm2 restart investment-crm-backend
          else
            echo "PM2 process 'investment-crm-backend' is not running. Starting with yarn start..."
            RUNNER_ALLOW_RUNASROOT=1 /opt/nodejs/bin/pm2 start yarn --name "investment-crm-backend" -- start
            RUNNER_ALLOW_RUNASROOT=1 /opt/nodejs/bin/pm2 save
          fi

      - name: Log PM2
        working-directory: ${{ secrets.BACKEND_DEPLOY_PATH }}
        run: RUNNER_ALLOW_RUNASROOT=1 /opt/nodejs/bin/pm2 log --nostream