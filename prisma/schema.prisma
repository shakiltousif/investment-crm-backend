// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  password              String
  firstName             String
  lastName              String
  phoneNumber           String?
  profilePicture        String?
  dateOfBirth           DateTime?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String?
  
  // KYC & Compliance
  kycStatus             KYCStatus   @default(PENDING)
  kycVerifiedAt         DateTime?
  documentType          String?
  documentNumber        String?
  documentExpiryDate    DateTime?
  
  // Account Status
  role                  UserRole    @default(CLIENT)
  isEmailVerified       Boolean     @default(false)
  emailVerifiedAt       DateTime?
  isActive              Boolean     @default(true)
  lastLoginAt           DateTime?
  failedLoginAttempts   Int         @default(0)
  lockedUntil           DateTime?
  twoFactorEnabled      Boolean     @default(false)
  twoFactorSecret       String?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  bankAccounts          BankAccount[]
  investments           Investment[]
  transactions          Transaction[]
  portfolios            Portfolio[]
  auditLogs             AuditLog[]
  documents             Document[]
  statements            Statement[]
  investmentApplications InvestmentApplication[]
  emailNotificationSettings EmailNotificationSettings?
  inAppNotificationSettings InAppNotificationSettings?
  notifications         Notification[]
  problemReports        ProblemReport[]           @relation("UserReports")
  resolvedProblemReports ProblemReport[]          @relation("ResolvedBy")
  problemReportResponses ProblemReportResponse[]
  
  @@index([email])
  @@index([kycStatus])
  @@index([role])
}

// Bank Account model
model BankAccount {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountHolderName     String
  accountNumber         String
  bankName              String
  bankCode              String?
  accountType           String      // Savings, Checking, etc.
  currency              String      @default("GBP")
  balance               Decimal     @default(0) @db.Decimal(15, 2)
  
  isVerified            Boolean     @default(false)
  verifiedAt            DateTime?
  isPrimary             Boolean     @default(false)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  transactions          Transaction[]
  
  @@unique([userId, accountNumber])
  @@index([userId])
}

// Portfolio model
model Portfolio {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  totalValue            Decimal     @default(0) @db.Decimal(15, 2)
  totalInvested         Decimal     @default(0) @db.Decimal(15, 2)
  totalGain             Decimal     @default(0) @db.Decimal(15, 2)
  gainPercentage        Decimal     @default(0) @db.Decimal(5, 2)
  
  isActive              Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  investments           Investment[]
  
  @@index([userId])
}

// Investment model
model Investment {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolioId           String
  portfolio             Portfolio   @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  
  type                  InvestmentType
  name                  String
  symbol                String?
  quantity              Decimal     @db.Decimal(15, 4)
  purchasePrice         Decimal     @db.Decimal(15, 2)
  currentPrice          Decimal     @db.Decimal(15, 2)
  totalValue            Decimal     @db.Decimal(15, 2)
  totalGain             Decimal     @db.Decimal(15, 2)
  gainPercentage        Decimal     @db.Decimal(5, 2)
  
  purchaseDate          DateTime
  maturityDate          DateTime?
  interestRate          Decimal?    @db.Decimal(5, 2)
  
  status                InvestmentStatus @default(PENDING)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  transactions          Transaction[]
  
  @@index([userId])
  @@index([portfolioId])
  @@index([type])
  @@index([status])
}

// Transaction model
model Transaction {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccountId         String?
  bankAccount           BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  investmentId          String?
  investment            Investment? @relation(fields: [investmentId], references: [id], onDelete: SetNull)
  
  type                  TransactionType
  amount                Decimal     @db.Decimal(15, 2)
  currency              String      @default("GBP")
  status                TransactionStatus @default(PENDING)
  description           String?
  
  transactionDate       DateTime    @default(now())
  completedAt           DateTime?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([transactionDate])
}

// Audit Log model
model AuditLog {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action                String
  entity                String
  entityId              String?
  changes               Json?
  ipAddress             String?
  userAgent             String?
  
  createdAt             DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Enums
enum UserRole {
  CLIENT
  ADMIN
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum InvestmentType {
  STOCK
  BOND
  CORPORATE_BOND
  TERM_DEPOSIT
  FIXED_RATE_DEPOSIT
  HIGH_INTEREST_SAVINGS
  IPO
  MUTUAL_FUND
  OTHER
}

enum InvestmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  MATURED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BUY
  SELL
  DIVIDEND
  INTEREST
  TRANSFER
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum DocumentType {
  KYC
  IDENTIFICATION
  PROOF_OF_ADDRESS
  BANK_STATEMENT
  TAX_DOCUMENT
  AGREEMENT
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

model MarketplaceItem {
  id                String          @id @default(cuid())
  name              String
  type              InvestmentType
  symbol            String?
  description       String?
  currentPrice      Decimal         @db.Decimal(15, 2)
  minimumInvestment Decimal         @db.Decimal(15, 2)
  maximumInvestment Decimal?        @db.Decimal(15, 2)
  currency          String          @default("USD")
  riskLevel         RiskLevel
  expectedReturn    Decimal?        @db.Decimal(5, 2)
  category          String?
  issuer            String?
  maturityDate      DateTime?
  isAvailable       Boolean         @default(true)
  lastPriceUpdate   DateTime?
  
  // Product-specific fields
  couponRate        Decimal?        @db.Decimal(5, 2)  // For Corporate Bonds
  interestRate      Decimal?        @db.Decimal(5, 2)   // For Savings/Fixed Deposits
  lockPeriodMonths  Int?                                // For Fixed Rate Deposits
  earlyWithdrawalPenalty Decimal?   @db.Decimal(5, 2)   // For Fixed Rate Deposits
  payoutFrequency   String?                             // For Bonds (monthly, quarterly, annual)
  nextPayoutDate    DateTime?                           // For Bonds
  applicationDeadline DateTime?                          // For IPO
  allocationDate    DateTime?                           // For IPO
  ipoStatus         String?                             // For IPO (OPEN, CLOSED, ALLOCATED)
  minimumLockAmount  Decimal?        @db.Decimal(15, 2) // For Fixed Deposits
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  investmentApplications InvestmentApplication[]
  
  @@map("marketplace_items")
}

// Investment Application model for IPO and other application-based products
model InvestmentApplication {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplaceItemId String
  marketplaceItem   MarketplaceItem @relation(fields: [marketplaceItemId], references: [id], onDelete: Cascade)
  
  requestedAmount   Decimal         @db.Decimal(15, 2)
  requestedQuantity Decimal?        @db.Decimal(15, 4)
  status            ApplicationStatus @default(PENDING)
  referenceNumber   String          @unique
  allocatedAmount   Decimal?        @db.Decimal(15, 2)
  allocatedQuantity Decimal?        @db.Decimal(15, 4)
  notes             String?
  
  submittedAt        DateTime        @default(now())
  allocatedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([marketplaceItemId])
  @@index([status])
  @@map("investment_applications")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  ALLOCATED
  REJECTED
  CANCELLED
}

// Document model for client uploads
model Document {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              DocumentType
  fileName          String
  fileUrl           String
  fileSize          Int             // Size in bytes
  mimeType          String
  description       String?
  status            DocumentStatus  @default(PENDING)
  
  uploadedBy        String          // User ID who uploaded
  isImportant       Boolean         @default(false) // Admin-uploaded important docs
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
}

// Statement model for admin-uploaded statements
model Statement {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  period            String          // e.g., "2024-Q1", "2024-01"
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  description       String?
  status            DocumentStatus  @default(PENDING)
  
  uploadedBy        String          // Admin user ID
  uploadedAt        DateTime        @default(now())
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([period])
}

// Support Settings model for admin-managed support information
model SupportSettings {
  id                String          @id @default(cuid())
  key               String          @unique  // e.g., "phone", "email", "hours", "address"
  value             String
  label             String?         // Display label (e.g., "Support Phone", "Support Email")
  displayOrder      Int             @default(0)  // For ordering in UI
  isActive          Boolean         @default(true)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("support_settings")
}

// Email Notification Settings model
model EmailNotificationSettings {
  id                String          @id @default(cuid())
  userId            String?         // null for global settings, userId for user-specific
  user              User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification type flags
  accountCreated    Boolean         @default(true)
  accountLocked     Boolean         @default(true)
  accountUnlocked   Boolean         @default(true)
  kycStatusChange   Boolean         @default(true)
  documentStatusChange Boolean      @default(true)
  documentUploaded  Boolean         @default(true)
  depositSubmitted  Boolean         @default(true)
  depositStatusChange Boolean       @default(true)
  withdrawalSubmitted Boolean       @default(true)
  withdrawalStatusChange Boolean    @default(true)
  investmentApplicationSubmitted Boolean @default(true)
  investmentApplicationStatusChange Boolean @default(true)
  investmentPurchase Boolean        @default(true)
  investmentMatured Boolean         @default(true)
  balanceAdjustment Boolean         @default(true)
  adminNotifications Boolean        @default(true)  // For admins only
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@unique([userId])
  @@index([userId])
  @@map("email_notification_settings")
}

// Notification Types enum
enum NotificationType {
  ACCOUNT_CREATED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  KYC_STATUS_CHANGE
  DOCUMENT_STATUS_CHANGE
  DOCUMENT_UPLOADED
  DEPOSIT_SUBMITTED
  DEPOSIT_STATUS_CHANGE
  WITHDRAWAL_SUBMITTED
  WITHDRAWAL_STATUS_CHANGE
  INVESTMENT_APPLICATION_SUBMITTED
  INVESTMENT_APPLICATION_STATUS_CHANGE
  INVESTMENT_PURCHASE
  INVESTMENT_MATURED
  BALANCE_ADJUSTMENT
  ADMIN_NOTIFICATION
  PROBLEM_REPORT_SUBMITTED
  PROBLEM_REPORT_RESPONSE
  PROBLEM_REPORT_STATUS_CHANGE
}

// SMTP Configuration model (single record for system-wide SMTP settings)
model SMTPConfiguration {
  id                String          @id @default(cuid())
  host              String          // SMTP host (e.g., smtp.hostinger.com)
  port              Int             // SMTP port (e.g., 465, 587)
  secure            Boolean         @default(true) // true for SSL/TLS (port 465), false for STARTTLS (port 587)
  user              String          // SMTP username/email
  password          String          // SMTP password (encrypted)
  from              String?         // From email address (defaults to user if not set)
  senderName        String?         // Sender name for email header (defaults to "Fidelity Investment Portal")
  isActive          Boolean         @default(true)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("smtp_configuration")
}

// Notification model
model Notification {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              NotificationType
  title             String
  message           String
  data              Json?           // Store related entity IDs and metadata
  actionUrl          String?         // Optional navigation path
  isRead            Boolean         @default(false)
  readAt            DateTime?
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([isRead])
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// In-App Notification Settings model
model InAppNotificationSettings {
  id                String          @id @default(cuid())
  userId            String?         // null for global settings, userId for user-specific
  user              User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification type flags
  accountCreated    Boolean         @default(true)
  accountLocked     Boolean         @default(true)
  accountUnlocked   Boolean         @default(true)
  kycStatusChange   Boolean         @default(true)
  documentStatusChange Boolean      @default(true)
  documentUploaded  Boolean         @default(true)
  depositSubmitted  Boolean         @default(true)
  depositStatusChange Boolean       @default(true)
  withdrawalSubmitted Boolean       @default(true)
  withdrawalStatusChange Boolean    @default(true)
  investmentApplicationSubmitted Boolean @default(true)
  investmentApplicationStatusChange Boolean @default(true)
  investmentPurchase Boolean        @default(true)
  investmentMatured Boolean         @default(true)
  balanceAdjustment Boolean         @default(true)
  adminNotifications Boolean        @default(true)  // For admins only
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@unique([userId])
  @@index([userId])
  @@map("in_app_notification_settings")
}

// Problem Report Enums
enum ProblemReportStatus {
  OPEN
  RESOLVED
}

enum ProblemPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProblemCategory {
  TECHNICAL
  ACCOUNT
  TRANSACTION
  INVESTMENT
  DOCUMENT
  OTHER
}

// Problem Report model
model ProblemReport {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation("UserReports", fields: [userId], references: [id], onDelete: Cascade)
  
  subject           String
  description       String
  category          ProblemCategory
  priority          ProblemPriority     @default(MEDIUM)
  status            ProblemReportStatus @default(OPEN)
  
  attachments       ProblemReportAttachment[]
  responses         ProblemReportResponse[]
  
  resolvedAt        DateTime?
  resolvedBy        String?             // Admin user ID
  resolvedByUser    User?               @relation("ResolvedBy", fields: [resolvedBy], references: [id])
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@map("problem_reports")
}

// Problem Report Attachment model
model ProblemReportAttachment {
  id                String          @id @default(cuid())
  problemReportId  String
  problemReport    ProblemReport    @relation(fields: [problemReportId], references: [id], onDelete: Cascade)
  
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  
  createdAt         DateTime        @default(now())
  
  @@index([problemReportId])
  @@map("problem_report_attachments")
}

// Problem Report Response model
model ProblemReportResponse {
  id                String          @id @default(cuid())
  problemReportId  String
  problemReport    ProblemReport    @relation(fields: [problemReportId], references: [id], onDelete: Cascade)
  
  userId            String          // User ID who responded (admin or user)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  isAdminResponse   Boolean         @default(false)
  
  message           String
  attachments       ProblemReportResponseAttachment[]
  
  createdAt         DateTime        @default(now())
  
  @@index([problemReportId])
  @@index([userId])
  @@map("problem_report_responses")
}

// Problem Report Response Attachment model
model ProblemReportResponseAttachment {
  id                String                @id @default(cuid())
  responseId        String
  response          ProblemReportResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  
  createdAt         DateTime        @default(now())
  
  @@index([responseId])
  @@map("problem_report_response_attachments")
}

// Email Template Type enum
enum EmailTemplateType {
  PASSWORD_RESET
  DEPOSIT_NOTIFICATION
  WITHDRAWAL_NOTIFICATION
  WELCOME_EMAIL
  ACCOUNT_CREATED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  KYC_STATUS_CHANGE
  DOCUMENT_STATUS_CHANGE
  DOCUMENT_UPLOADED_BY_ADMIN
  INVESTMENT_APPLICATION_SUBMITTED
  INVESTMENT_APPLICATION_STATUS_CHANGE
  INVESTMENT_PURCHASE_CONFIRMATION
  INVESTMENT_MATURED
  BALANCE_ADJUSTMENT
  ADMIN_NOTIFICATION
  PROBLEM_REPORT_SUBMITTED
  PROBLEM_REPORT_RESPONSE
  PROBLEM_REPORT_STATUS_CHANGE
  ADMIN_PROBLEM_REPORT_NOTIFICATION
}

// Email Template model
model EmailTemplate {
  id                String            @id @default(cuid())
  type              EmailTemplateType @unique
  name              String
  description       String?
  subject           String
  htmlContent       String            @db.Text
  cssStyles         String?           @db.Text
  variables         Json              // Array of variable definitions
  isActive          Boolean           @default(true)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

