// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  password              String
  firstName             String
  lastName              String
  phoneNumber           String?
  profilePicture        String?
  dateOfBirth           DateTime?
  address               String?
  city                  String?
  state                 String?
  zipCode               String?
  country               String?
  
  // KYC & Compliance
  kycStatus             KYCStatus   @default(PENDING)
  kycVerifiedAt         DateTime?
  documentType          String?
  documentNumber        String?
  documentExpiryDate    DateTime?
  
  // Account Status
  role                  UserRole    @default(CLIENT)
  isEmailVerified       Boolean     @default(false)
  emailVerifiedAt       DateTime?
  isActive              Boolean     @default(true)
  lastLoginAt           DateTime?
  failedLoginAttempts   Int         @default(0)
  lockedUntil           DateTime?
  twoFactorEnabled      Boolean     @default(false)
  twoFactorSecret       String?
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  
  // Timestamps
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  bankAccounts          BankAccount[]
  investments           Investment[]
  transactions          Transaction[]
  portfolios            Portfolio[]
  auditLogs             AuditLog[]
  documents             Document[]
  statements            Statement[]
  investmentApplications InvestmentApplication[]
  
  @@index([email])
  @@index([kycStatus])
  @@index([role])
}

// Bank Account model
model BankAccount {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountHolderName     String
  accountNumber         String
  bankName              String
  bankCode              String?
  accountType           String      // Savings, Checking, etc.
  currency              String      @default("GBP")
  balance               Decimal     @default(0) @db.Decimal(15, 2)
  
  isVerified            Boolean     @default(false)
  verifiedAt            DateTime?
  isPrimary             Boolean     @default(false)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  transactions          Transaction[]
  
  @@unique([userId, accountNumber])
  @@index([userId])
}

// Portfolio model
model Portfolio {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  totalValue            Decimal     @default(0) @db.Decimal(15, 2)
  totalInvested         Decimal     @default(0) @db.Decimal(15, 2)
  totalGain             Decimal     @default(0) @db.Decimal(15, 2)
  gainPercentage        Decimal     @default(0) @db.Decimal(5, 2)
  
  isActive              Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  investments           Investment[]
  
  @@index([userId])
}

// Investment model
model Investment {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolioId           String
  portfolio             Portfolio   @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  
  type                  InvestmentType
  name                  String
  symbol                String?
  quantity              Decimal     @db.Decimal(15, 4)
  purchasePrice         Decimal     @db.Decimal(15, 2)
  currentPrice          Decimal     @db.Decimal(15, 2)
  totalValue            Decimal     @db.Decimal(15, 2)
  totalGain             Decimal     @db.Decimal(15, 2)
  gainPercentage        Decimal     @db.Decimal(5, 2)
  
  purchaseDate          DateTime
  maturityDate          DateTime?
  interestRate          Decimal?    @db.Decimal(5, 2)
  
  status                InvestmentStatus @default(ACTIVE)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  transactions          Transaction[]
  
  @@index([userId])
  @@index([portfolioId])
  @@index([type])
}

// Transaction model
model Transaction {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankAccountId         String?
  bankAccount           BankAccount? @relation(fields: [bankAccountId], references: [id], onDelete: SetNull)
  investmentId          String?
  investment            Investment? @relation(fields: [investmentId], references: [id], onDelete: SetNull)
  
  type                  TransactionType
  amount                Decimal     @db.Decimal(15, 2)
  currency              String      @default("GBP")
  status                TransactionStatus @default(PENDING)
  description           String?
  
  transactionDate       DateTime    @default(now())
  completedAt           DateTime?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([transactionDate])
}

// Audit Log model
model AuditLog {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action                String
  entity                String
  entityId              String?
  changes               Json?
  ipAddress             String?
  userAgent             String?
  
  createdAt             DateTime    @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// Enums
enum UserRole {
  CLIENT
  ADMIN
}

enum KYCStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum InvestmentType {
  STOCK
  BOND
  CORPORATE_BOND
  TERM_DEPOSIT
  FIXED_RATE_DEPOSIT
  HIGH_INTEREST_SAVINGS
  IPO
  PRIVATE_EQUITY
  MUTUAL_FUND
  ETF
  CRYPTOCURRENCY
  OTHER
}

enum InvestmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  MATURED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  BUY
  SELL
  DIVIDEND
  INTEREST
  TRANSFER
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum DocumentType {
  KYC
  IDENTIFICATION
  PROOF_OF_ADDRESS
  BANK_STATEMENT
  TAX_DOCUMENT
  AGREEMENT
  OTHER
}

model MarketplaceItem {
  id                String          @id @default(cuid())
  name              String
  type              InvestmentType
  symbol            String?
  description       String?
  currentPrice      Decimal         @db.Decimal(15, 2)
  minimumInvestment Decimal         @db.Decimal(15, 2)
  maximumInvestment Decimal?        @db.Decimal(15, 2)
  currency          String          @default("USD")
  riskLevel         RiskLevel
  expectedReturn    Decimal?        @db.Decimal(5, 2)
  category          String?
  issuer            String?
  maturityDate      DateTime?
  isAvailable       Boolean         @default(true)
  lastPriceUpdate   DateTime?
  
  // Product-specific fields
  couponRate        Decimal?        @db.Decimal(5, 2)  // For Corporate Bonds
  interestRate      Decimal?        @db.Decimal(5, 2)   // For Savings/Fixed Deposits
  lockPeriodMonths  Int?                                // For Fixed Rate Deposits
  earlyWithdrawalPenalty Decimal?   @db.Decimal(5, 2)   // For Fixed Rate Deposits
  payoutFrequency   String?                             // For Bonds (monthly, quarterly, annual)
  nextPayoutDate    DateTime?                           // For Bonds
  applicationDeadline DateTime?                          // For IPO
  allocationDate    DateTime?                           // For IPO
  ipoStatus         String?                             // For IPO (OPEN, CLOSED, ALLOCATED)
  minimumLockAmount  Decimal?        @db.Decimal(15, 2) // For Fixed Deposits
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  investmentApplications InvestmentApplication[]
  
  @@map("marketplace_items")
}

// Investment Application model for IPO and other application-based products
model InvestmentApplication {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  marketplaceItemId String
  marketplaceItem   MarketplaceItem @relation(fields: [marketplaceItemId], references: [id], onDelete: Cascade)
  
  requestedAmount   Decimal         @db.Decimal(15, 2)
  requestedQuantity Decimal?        @db.Decimal(15, 4)
  status            ApplicationStatus @default(PENDING)
  referenceNumber   String          @unique
  allocatedAmount   Decimal?        @db.Decimal(15, 2)
  allocatedQuantity Decimal?        @db.Decimal(15, 4)
  notes             String?
  
  submittedAt        DateTime        @default(now())
  allocatedAt        DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([marketplaceItemId])
  @@index([status])
  @@map("investment_applications")
}

enum ApplicationStatus {
  PENDING
  APPROVED
  ALLOCATED
  REJECTED
  CANCELLED
}

// Document model for client uploads
model Document {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type              DocumentType
  fileName          String
  fileUrl           String
  fileSize          Int             // Size in bytes
  mimeType          String
  description       String?
  
  uploadedBy        String          // User ID who uploaded
  isImportant       Boolean         @default(false) // Admin-uploaded important docs
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([type])
}

// Statement model for admin-uploaded statements
model Statement {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  period            String          // e.g., "2024-Q1", "2024-01"
  fileName          String
  fileUrl           String
  fileSize          Int
  mimeType          String
  description       String?
  
  uploadedBy        String          // Admin user ID
  uploadedAt        DateTime        @default(now())
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@index([userId])
  @@index([period])
}

// Support Settings model for admin-managed support information
model SupportSettings {
  id                String          @id @default(cuid())
  key               String          @unique  // e.g., "phone", "email", "hours", "address"
  value             String
  label             String?         // Display label (e.g., "Support Phone", "Support Email")
  displayOrder      Int             @default(0)  // For ordering in UI
  isActive          Boolean         @default(true)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("support_settings")
}

